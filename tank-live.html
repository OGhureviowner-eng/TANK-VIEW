<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>IRON COMMAND ‚Äî LIVE</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet"/>
<style>
:root {
  --g: #39ff14;
  --g2: rgba(57,255,20,0.65);
  --g3: rgba(57,255,20,0.18);
  --g4: rgba(57,255,20,0.07);
  --amber: #ffb000;
  --red: #ff2828;
  --blue: #00d4ff;
  --bg: #010401;
  --glow: 0 0 10px rgba(57,255,20,0.75), 0 0 28px rgba(57,255,20,0.3);
  --glow-sm: 0 0 5px rgba(57,255,20,0.55);
  --font: 'Share Tech Mono', monospace;
  --hud: 'Orbitron', sans-serif;
}

* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; user-select:none; touch-action:none; }

html, body {
  width:100%; height:100%;
  overflow:hidden;
  background:#000;
  font-family:var(--font);
  color:var(--g);
}

/* ‚îÄ‚îÄ‚îÄ LANDSCAPE LOCK ‚îÄ‚îÄ‚îÄ */
#rotate-msg {
  display:none;
  position:fixed; inset:0;
  background:#000;
  color:var(--g);
  font-family:var(--hud);
  font-size:1.1rem;
  letter-spacing:0.2em;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:20px;
  z-index:99999;
  text-align:center;
}
#rotate-msg .arrow { font-size:3rem; animation:rotate-anim 1.5s ease-in-out infinite; }
@keyframes rotate-anim {
  0%,100%{transform:rotate(0deg)} 50%{transform:rotate(90deg)}
}
@media (orientation:portrait) {
  #rotate-msg { display:flex; }
  #boot, #hud { display:none !important; }
}

/* ‚îÄ‚îÄ‚îÄ SCANLINES ‚îÄ‚îÄ‚îÄ */
body::before {
  content:'';
  position:fixed; inset:0;
  background:repeating-linear-gradient(0deg, transparent 0, transparent 2px, rgba(0,0,0,0.09) 2px, rgba(0,0,0,0.09) 3px);
  pointer-events:none; z-index:9000;
}
body::after {
  content:'';
  position:fixed; inset:0;
  background:radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.7) 100%);
  pointer-events:none; z-index:9001;
}

/* ‚îÄ‚îÄ‚îÄ CAMERA BACKGROUND ‚îÄ‚îÄ‚îÄ */
#camera-bg {
  position:fixed; inset:0;
  z-index:0;
  background:#000;
  overflow:hidden;
}
#camera-video {
  width:100%; height:100%;
  object-fit:cover;
  opacity:0.75;
  filter:saturate(0.6) contrast(1.1) brightness(0.8);
  transform:scaleX(1);
}
/* Night-vision green tint overlay */
#camera-tint {
  position:absolute; inset:0;
  background:rgba(10,40,10,0.35);
  mix-blend-mode:multiply;
  pointer-events:none;
}
#camera-noise {
  position:absolute; inset:0;
  pointer-events:none;
  opacity:0.04;
  animation:noise 0.1s steps(1) infinite;
}
@keyframes noise {
  0%{background-position:0 0}
  10%{background-position:-5% -10%}
  20%{background-position:-15% 5%}
  30%{background-position:7% -25%}
  40%{background-position:-5% 25%}
  50%{background-position:-15% 10%}
  60%{background-position:15% 0%}
  70%{background-position:0 15%}
  80%{background-position:3% 35%}
  90%{background-position:-10% 10%}
  100%{background-position:0 0}
}
#cam-offline {
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  flex-direction:column; gap:10px;
  color:rgba(57,255,20,0.3);
  font-size:0.65rem;
  letter-spacing:0.2em;
  text-align:center;
}

/* ‚îÄ‚îÄ‚îÄ BOOT SCREEN ‚îÄ‚îÄ‚îÄ */
#boot {
  position:fixed; inset:0;
  background:rgba(1,4,1,0.97);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:14px; padding:20px;
  z-index:5000;
}
#boot.gone { display:none; }
.boot-logo {
  font-family:var(--hud); font-size:clamp(1.1rem,4vw,1.8rem);
  font-weight:900; color:var(--g);
  text-shadow:var(--glow); letter-spacing:0.22em; text-align:center;
  animation:pulse-glow 2s ease infinite;
}
.boot-grid {
  display:grid; grid-template-columns:1fr 1fr;
  gap:8px 20px;
  font-size:0.62rem;
  border:1px solid rgba(57,255,20,0.2);
  padding:12px 18px;
  max-width:420px;
}
.boot-item { display:flex; align-items:center; gap:6px; line-height:1.8; }
.boot-icon { font-size:0.9rem; }
.boot-desc { color:rgba(57,255,20,0.5); }
.boot-desc b { color:var(--g); }
#activate-btn {
  font-family:var(--hud); font-size:0.85rem; font-weight:700;
  letter-spacing:0.2em; text-transform:uppercase;
  padding:14px 32px;
  background:rgba(57,255,20,0.1); border:2px solid var(--g); color:var(--g);
  cursor:pointer;
  clip-path:polygon(10px 0%,100% 0%,calc(100% - 10px) 100%,0% 100%);
  box-shadow:var(--glow);
  animation:pulse-border 1.5s ease infinite;
}
#boot-log {
  font-size:0.6rem; color:rgba(57,255,20,0.5);
  text-align:center; line-height:2; letter-spacing:0.1em;
  max-width:360px;
}
.log-ok   { color:var(--g); }
.log-warn { color:var(--amber); }
.log-err  { color:var(--red); }

/* ‚îÄ‚îÄ‚îÄ MAIN HUD ‚îÄ‚îÄ‚îÄ */
#hud {
  position:fixed; inset:0;
  display:none; z-index:10;
}
#hud.active { display:block; }

/* Flash overlays */
#impact-flash { position:fixed; inset:0; background:rgba(255,30,30,0); pointer-events:none; z-index:8000; transition:background 0.04s; }
#impact-flash.hit { background:rgba(255,30,30,0.5); }
#fire-flash { position:fixed; inset:0; background:rgba(255,190,0,0); pointer-events:none; z-index:7999; transition:background 0.04s; }
#fire-flash.fired { background:rgba(255,200,0,0.28); }
#threat-overlay {
  position:fixed; inset:0; pointer-events:none; z-index:7500;
  opacity:0; transition:opacity 0.15s;
}
#threat-overlay.active {
  opacity:1; border:3px solid var(--red);
  box-shadow:inset 0 0 60px rgba(255,32,32,0.2);
  animation:threat-pulse 0.5s ease infinite;
}
#threat-text {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%);
  font-family:var(--hud); font-size:clamp(0.9rem,4vw,1.6rem);
  font-weight:900; color:var(--red);
  text-shadow:0 0 18px var(--red); letter-spacing:0.3em;
  display:none;
}
#threat-overlay.active #threat-text { display:block; }

/* Particle canvas */
#shake-canvas { position:fixed; inset:0; pointer-events:none; z-index:7600; }

/* ‚îÄ‚îÄ‚îÄ COMPASS TAPE ‚îÄ‚îÄ‚îÄ */
#compass-wrap {
  position:absolute; top:6px; left:50%;
  transform:translateX(-50%);
  width:min(55vw,340px); pointer-events:none;
}
#compass-tape {
  height:26px; overflow:hidden;
  border:1px solid rgba(57,255,20,0.22);
  background:rgba(1,4,1,0.82);
  position:relative;
}
#compass-inner {
  position:absolute; top:0; height:100%;
  display:flex; align-items:center;
  white-space:nowrap; font-size:0.58rem; letter-spacing:0.06em;
  color:var(--g2); will-change:transform;
}
.c-major { color:var(--g); font-weight:bold; font-size:0.72rem; }
.c-minor { color:rgba(57,255,20,0.38); font-size:0.5rem; }
#compass-ptr {
  position:absolute; bottom:0; left:50%;
  transform:translateX(-50%);
  width:0; height:0;
  border-left:4px solid transparent;
  border-right:4px solid transparent;
  border-bottom:6px solid var(--g);
  filter:drop-shadow(0 0 4px var(--g));
}
#compass-hdg {
  text-align:center; font-family:var(--hud);
  font-size:0.65rem; font-weight:700; color:var(--g);
  text-shadow:var(--glow-sm); letter-spacing:0.12em;
  margin-top:2px;
}

/* ‚îÄ‚îÄ‚îÄ CROSSHAIR ‚îÄ‚îÄ‚îÄ */
#sight-wrap {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%);
  width:min(60vw,60vh); height:min(60vw,60vh);
  pointer-events:none;
}
#sight-svg { width:100%; height:100%; filter:drop-shadow(0 0 7px rgba(57,255,20,0.55)); }
#reticle-group { transform-origin:50px 50px; transform-box:fill-box; }
#lock-ring { opacity:0; stroke:var(--g); stroke-width:1; fill:none; }
#lock-ring.locked { opacity:1; animation:lock-pulse 0.7s ease infinite; }

/* ‚îÄ‚îÄ‚îÄ LEFT PANEL (elevation + live sensor bars) ‚îÄ‚îÄ‚îÄ */
#left-panel {
  position:absolute; left:6px; top:40px; bottom:36px;
  width:58px;
  display:flex; flex-direction:column; gap:5px;
  pointer-events:none;
}
.lp-block {
  background:rgba(1,4,1,0.8);
  border:1px solid rgba(57,255,20,0.2);
  padding:4px 5px;
  clip-path:polygon(0 0,calc(100% - 5px) 0,100% 5px,100% 100%,0 100%);
}
.lp-label { font-size:0.46rem; letter-spacing:0.12em; color:var(--g2); text-transform:uppercase; margin-bottom:2px; display:block; }
.lp-val   { font-family:var(--hud); font-size:0.75rem; font-weight:700; color:var(--g); text-shadow:var(--glow-sm); line-height:1; }
.lp-unit  { font-size:0.42rem; color:rgba(57,255,20,0.4); }

/* Mini sparkline */
.sparkline { width:100%; height:20px; margin-top:3px; }

/* Elevation track */
#elev-block {
  flex:1;
  background:rgba(1,4,1,0.8);
  border:1px solid rgba(57,255,20,0.2);
  display:flex; flex-direction:column; align-items:center;
  gap:3px; padding:4px 5px;
}
#elev-track {
  flex:1; width:7px;
  background:rgba(57,255,20,0.07);
  border:1px solid rgba(57,255,20,0.18);
  position:relative;
}
#elev-ind {
  position:absolute; left:50%; width:18px; height:2px;
  background:var(--g); box-shadow:var(--glow-sm);
  transform:translate(-50%,-50%); top:50%;
  transition:top 0.08s linear;
}
#elev-ind::before {
  content:''; position:absolute; right:100%; top:-2px;
  width:6px; height:5px;
  border-right:5px solid var(--g);
  border-top:2.5px solid transparent;
  border-bottom:2.5px solid transparent;
}
#elev-zero { position:absolute; left:-4px; top:50%; width:calc(100%+8px); height:1px; background:rgba(57,255,20,0.28); transform:translateY(-50%); }
#elev-val { font-family:var(--hud); font-size:0.58rem; color:var(--g); text-shadow:var(--glow-sm); }

/* ‚îÄ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ‚îÄ */
#right-panel {
  position:absolute; right:6px; top:40px; bottom:36px;
  width:62px;
  display:flex; flex-direction:column; gap:5px;
  pointer-events:none;
}
.rp-block {
  background:rgba(1,4,1,0.8);
  border:1px solid rgba(57,255,20,0.2);
  padding:4px 6px;
  text-align:right;
  clip-path:polygon(0 0,100% 0,100% 100%,5px 100%);
}
.rp-label { font-size:0.45rem; letter-spacing:0.12em; color:var(--g2); text-transform:uppercase; display:block; }
.rp-val   { font-family:var(--hud); font-size:0.85rem; font-weight:700; color:var(--g); text-shadow:var(--glow-sm); line-height:1.1; display:block; }
.rp-unit  { font-size:0.42rem; color:rgba(57,255,20,0.4); display:block; }
.rp-val.amber { color:var(--amber); text-shadow:0 0 6px var(--amber); }
.rp-val.red   { color:var(--red);   text-shadow:0 0 6px var(--red); }

/* ‚îÄ‚îÄ‚îÄ GPS PANEL ‚îÄ‚îÄ‚îÄ */
#gps-panel {
  position:absolute; top:42px; left:68px;
  background:rgba(1,4,1,0.8);
  border:1px solid rgba(57,255,20,0.2);
  padding:5px 8px;
  font-size:0.55rem; line-height:1.9;
  clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,0 100%);
  pointer-events:none; min-width:150px;
}
.gp-row { display:flex; justify-content:space-between; gap:10px; }
.gp-k { color:var(--g2); }
.gp-v { color:var(--g); font-weight:bold; }
.gp-v.acq { color:var(--amber); animation:blink 1s step-end infinite; }
#gps-bar-wrap { width:100%; height:2px; background:rgba(57,255,20,0.1); margin-top:3px; }
#gps-bar-fill { height:100%; background:var(--g); transition:width 1s; width:0%; }

/* ‚îÄ‚îÄ‚îÄ LIVE SENSOR READOUT ‚îÄ‚îÄ‚îÄ */
#sensor-live {
  position:absolute; top:42px; right:78px;
  background:rgba(1,4,1,0.8);
  border:1px solid rgba(57,255,20,0.2);
  padding:5px 8px;
  font-size:0.53rem; line-height:1.85;
  text-align:right;
  clip-path:polygon(6px 0,100% 0,100% 100%,0 100%,0 6px);
  pointer-events:none; min-width:145px;
}
.sl-row { display:flex; justify-content:space-between; gap:10px; }
.sl-k { color:var(--g2); }
.sl-v { color:var(--g); font-weight:bold; }
.sl-v.live { color:var(--blue); text-shadow:0 0 5px var(--blue); }

/* ‚îÄ‚îÄ‚îÄ MINIMAP ‚îÄ‚îÄ‚îÄ */
#minimap-wrap {
  position:absolute; bottom:42px; right:78px;
  pointer-events:none;
}
#minimap-canvas {
  border-radius:50%;
  border:1px solid rgba(57,255,20,0.28);
  display:block;
  box-shadow:var(--glow-sm), inset 0 0 16px rgba(0,0,0,0.6);
}
#minimap-lbl {
  font-size:0.45rem; letter-spacing:0.15em;
  color:var(--g2); text-align:center; margin-top:2px;
}

/* ‚îÄ‚îÄ‚îÄ BOTTOM HUD ‚îÄ‚îÄ‚îÄ */
#bottom-hud {
  position:absolute; bottom:0; left:0; right:0;
  height:36px;
  background:rgba(1,4,1,0.85);
  border-top:1px solid rgba(57,255,20,0.18);
  display:flex; align-items:center;
  padding:0 10px; gap:12px;
  font-size:0.52rem; letter-spacing:0.1em;
  color:var(--g2); pointer-events:none;
}
#sb-mode { color:var(--g); font-weight:bold; font-family:var(--hud); font-size:0.52rem; }
.sb-sep { color:rgba(57,255,20,0.2); }
#sb-time { color:var(--g); }
.sb-spacer { flex:1; }

/* ‚îÄ‚îÄ‚îÄ AMMO + FIRE (bottom center) ‚îÄ‚îÄ‚îÄ */
#fire-zone {
  position:absolute; bottom:44px; left:50%;
  transform:translateX(-50%);
  display:flex; align-items:center; gap:10px;
  pointer-events:all;
}
#ammo-display {
  background:rgba(1,4,1,0.88);
  border:1px solid rgba(57,255,20,0.25);
  padding:6px 10px; text-align:center;
  clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%);
}
#ammo-count {
  font-family:var(--hud); font-size:1.6rem; font-weight:900;
  color:var(--g); text-shadow:var(--glow); line-height:1;
}
.ammo-lbl { font-size:0.45rem; color:var(--g2); letter-spacing:0.18em; text-transform:uppercase; }
.ammo-type-lbl { font-size:0.48rem; color:var(--amber); letter-spacing:0.1em; }

#fire-btn {
  width:66px; height:66px; border-radius:50%;
  background:rgba(255,20,20,0.1); border:2px solid var(--red);
  color:var(--red); font-family:var(--hud);
  font-size:0.6rem; font-weight:700; letter-spacing:0.12em;
  cursor:pointer;
  text-shadow:0 0 8px var(--red);
  box-shadow:0 0 14px rgba(255,32,32,0.28), inset 0 0 18px rgba(255,32,32,0.05);
  display:flex; align-items:center; justify-content:center;
  -webkit-appearance:none; flex-shrink:0;
  transition:all 0.08s;
}
#fire-btn:active, #fire-btn.firing {
  background:rgba(255,32,32,0.38);
  box-shadow:0 0 38px rgba(255,32,32,0.75), inset 0 0 28px rgba(255,32,32,0.28);
  transform:scale(0.92);
}

/* Ammo selector */
#ammo-sel {
  display:flex; flex-direction:column; gap:3px;
  pointer-events:all;
}
.ammo-btn {
  font-family:var(--font); font-size:0.5rem;
  letter-spacing:0.1em; text-transform:uppercase;
  padding:4px 7px;
  background:rgba(1,4,1,0.85);
  border:1px solid rgba(57,255,20,0.18);
  color:var(--g2); cursor:pointer;
  clip-path:polygon(3px 0,100% 0,calc(100% - 3px) 100%,0 100%);
  transition:all 0.12s;
}
.ammo-btn.active {
  background:rgba(57,255,20,0.1); border-color:var(--g);
  color:var(--g); box-shadow:var(--glow-sm);
}

/* ‚îÄ‚îÄ‚îÄ LIVE GRAPH CANVAS ‚îÄ‚îÄ‚îÄ */
#graph-panel {
  position:absolute; bottom:44px; left:68px;
  background:rgba(1,4,1,0.82);
  border:1px solid rgba(57,255,20,0.18);
  padding:4px 6px;
  pointer-events:none;
}
#graph-canvas { display:block; }
.graph-lbl { font-size:0.44rem; color:var(--g2); letter-spacing:0.1em; text-align:center; margin-top:2px; }

/* ‚îÄ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ‚îÄ */
@keyframes pulse-glow {
  0%,100%{text-shadow:0 0 10px rgba(57,255,20,0.5)} 50%{text-shadow:0 0 28px rgba(57,255,20,1),0 0 55px rgba(57,255,20,0.5)}
}
@keyframes pulse-border {
  0%,100%{box-shadow:var(--glow)} 50%{box-shadow:0 0 28px rgba(57,255,20,0.9),0 0 55px rgba(57,255,20,0.4)}
}
@keyframes blink {0%,100%{opacity:1}50%{opacity:0}}
@keyframes lock-pulse {
  0%,100%{stroke-opacity:1} 50%{stroke-opacity:0.25}
}
@keyframes threat-pulse {
  0%,100%{box-shadow:inset 0 0 60px rgba(255,32,32,0.2)} 50%{box-shadow:inset 0 0 110px rgba(255,32,32,0.45)}
}
@keyframes shake-anim {
  0%{transform:translate(0,0)} 15%{transform:translate(-7px,3px)} 30%{transform:translate(5px,-5px)}
  45%{transform:translate(-3px,7px)} 60%{transform:translate(6px,-2px)}
  75%{transform:translate(-4px,4px)} 90%{transform:translate(3px,-3px)} 100%{transform:translate(0,0)}
}
.shaking{animation:shake-anim 0.45s ease;}

/* ‚îÄ‚îÄ‚îÄ RANGE READOUT ‚îÄ‚îÄ‚îÄ */
#range-readout {
  position:absolute; top:50%;
  left:calc(50% + min(32vw,32vh) + 8px);
  transform:translateY(-50%);
  font-family:var(--hud); font-size:0.62rem;
  color:var(--g); text-shadow:var(--glow-sm);
  letter-spacing:0.08em; pointer-events:none;
  line-height:2; white-space:nowrap;
  background:rgba(1,4,1,0.7);
  padding:4px 8px;
  border:1px solid rgba(57,255,20,0.18);
  clip-path:polygon(5px 0,100% 0,100% 100%,0 100%,0 5px);
}

/* ‚îÄ‚îÄ‚îÄ CAM OVERLAY ‚îÄ‚îÄ‚îÄ */
#cam-status {
  position:absolute; top:6px; right:78px;
  font-size:0.5rem; letter-spacing:0.12em;
  padding:3px 7px;
  background:rgba(1,4,1,0.8);
  border:1px solid rgba(57,255,20,0.2);
  pointer-events:none;
}
#cam-dot { display:inline-block; width:5px; height:5px; border-radius:50%; background:var(--red); margin-right:4px; animation:blink 1s step-end infinite; }
#cam-dot.live { background:var(--g); animation:none; }

/* Horizon line */
#horizon-line {
  position:absolute; top:50%; left:15%;
  width:70%; height:1px;
  background:linear-gradient(90deg,transparent,rgba(57,255,20,0.2),rgba(57,255,20,0.2),transparent);
  transform-origin:center; pointer-events:none;
}

/* Lock msg */
#lock-msg {
  position:absolute; bottom:42px; left:50%;
  transform:translateX(-50%);
  font-size:0.5rem; color:rgba(57,255,20,0.3);
  letter-spacing:0.14em; white-space:nowrap; pointer-events:none;
  display:none;
}
</style>
</head>
<body>

<!-- Rotate prompt -->
<div id="rotate-msg">
  <div class="arrow">üì±</div>
  <div>ROTATE DEVICE TO LANDSCAPE</div>
  <div style="font-size:0.65rem;color:var(--g2);letter-spacing:0.2em;">IRON COMMAND REQUIRES LANDSCAPE MODE</div>
</div>

<!-- Camera background -->
<div id="camera-bg">
  <video id="camera-video" autoplay playsinline muted></video>
  <div id="camera-tint"></div>
  <canvas id="camera-noise"></canvas>
  <div id="cam-offline">
    <div>üì∑</div>
    <div>CAM OFFLINE</div>
    <div style="font-size:0.5rem;opacity:0.5">GRANT CAMERA ACCESS</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê -->
<div id="boot">
  <div class="boot-logo">‚äï IRON COMMAND<br><span style="font-size:0.45em;letter-spacing:0.3em;">L I V E  ¬∑  S Y S T E M S</span></div>
  <div class="boot-grid">
    <div class="boot-item"><span class="boot-icon">üì∑</span><span class="boot-desc"><b>Camera</b><br>Live battlefield view</span></div>
    <div class="boot-item"><span class="boot-icon">üìê</span><span class="boot-desc"><b>Gyroscope</b><br>Gun elevation & aim</span></div>
    <div class="boot-item"><span class="boot-icon">üß≠</span><span class="boot-desc"><b>Compass</b><br>Real heading</span></div>
    <div class="boot-item"><span class="boot-icon">üìç</span><span class="boot-desc"><b>GPS</b><br>Live coordinates</span></div>
    <div class="boot-item"><span class="boot-icon">‚ö°</span><span class="boot-desc"><b>Accelerometer</b><br>Speed & impact</span></div>
    <div class="boot-item"><span class="boot-icon">üîã</span><span class="boot-desc"><b>Battery</b><br>Fuel gauge</span></div>
  </div>
  <button id="activate-btn" onclick="activateSystems()">‚ñ∂ ACTIVATE ALL SYSTEMS</button>
  <div id="boot-log">Awaiting activation...</div>
</div>

<!-- ‚ïê‚ïê‚ïê MAIN HUD ‚ïê‚ïê‚ïê -->
<div id="hud">
  <div id="impact-flash"></div>
  <div id="fire-flash"></div>
  <div id="threat-overlay"><div id="threat-text">‚ö† INCOMING ‚ö†</div></div>
  <canvas id="shake-canvas"></canvas>

  <!-- Horizon -->
  <div id="horizon-line"></div>

  <!-- Compass -->
  <div id="compass-wrap">
    <div id="compass-tape">
      <div id="compass-inner"></div>
      <div id="compass-ptr"></div>
    </div>
    <div id="compass-hdg">HDG 000¬∞ N</div>
  </div>

  <!-- Camera status -->
  <div id="cam-status"><span id="cam-dot"></span><span id="cam-label">CAM OFFLINE</span></div>

  <!-- Crosshair -->
  <div id="sight-wrap">
    <svg id="sight-svg" viewBox="0 0 100 100">
      <defs>
        <radialGradient id="sightGrad" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="rgba(57,255,20,0)"/>
          <stop offset="82%" stop-color="rgba(57,255,20,0)"/>
          <stop offset="100%" stop-color="rgba(57,255,20,0.05)"/>
        </radialGradient>
      </defs>
      <circle cx="50" cy="50" r="48" fill="none" stroke="rgba(57,255,20,0.18)" stroke-width="0.4"/>
      <circle cx="50" cy="50" r="30" fill="none" stroke="rgba(57,255,20,0.12)" stroke-width="0.3"/>
      <circle cx="50" cy="50" r="15" fill="none" stroke="rgba(57,255,20,0.22)" stroke-width="0.4"/>
      <circle id="lock-ring" cx="50" cy="50" r="45"/>
      <circle cx="50" cy="50" r="48" fill="url(#sightGrad)"/>
      <g id="reticle-group">
        <line x1="50" y1="2" x2="50" y2="35" stroke="#39ff14" stroke-width="0.7" opacity="0.9"/>
        <line x1="50" y1="65" x2="50" y2="98" stroke="#39ff14" stroke-width="0.7" opacity="0.9"/>
        <line x1="2" y1="50" x2="35" y2="50" stroke="#39ff14" stroke-width="0.7" opacity="0.9"/>
        <line x1="65" y1="50" x2="98" y2="50" stroke="#39ff14" stroke-width="0.7" opacity="0.9"/>
        <!-- Range lines -->
        <line x1="40" y1="42" x2="60" y2="42" stroke="rgba(57,255,20,0.28)" stroke-width="0.35"/>
        <line x1="42" y1="45" x2="58" y2="45" stroke="rgba(57,255,20,0.2)" stroke-width="0.28"/>
        <line x1="40" y1="58" x2="60" y2="58" stroke="rgba(57,255,20,0.28)" stroke-width="0.35"/>
        <text x="61" y="42.5" fill="rgba(57,255,20,0.38)" font-family="Share Tech Mono" font-size="5">2km</text>
        <text x="61" y="45.5" fill="rgba(57,255,20,0.28)" font-family="Share Tech Mono" font-size="4.5">1km</text>
        <!-- Corner marks -->
        <line x1="50" y1="2" x2="50" y2="5" stroke="#39ff14" stroke-width="1"/>
        <line x1="50" y1="95" x2="50" y2="98" stroke="#39ff14" stroke-width="1"/>
        <line x1="2" y1="50" x2="5" y2="50" stroke="#39ff14" stroke-width="1"/>
        <line x1="95" y1="50" x2="98" y2="50" stroke="#39ff14" stroke-width="1"/>
        <!-- Diagonals -->
        <line x1="17" y1="17" x2="20" y2="20" stroke="rgba(57,255,20,0.45)" stroke-width="0.5"/>
        <line x1="83" y1="17" x2="80" y2="20" stroke="rgba(57,255,20,0.45)" stroke-width="0.5"/>
        <line x1="17" y1="83" x2="20" y2="80" stroke="rgba(57,255,20,0.45)" stroke-width="0.5"/>
        <line x1="83" y1="83" x2="80" y2="80" stroke="rgba(57,255,20,0.45)" stroke-width="0.5"/>
        <!-- Corner frame -->
        <path d="M4,10 L4,4 L10,4" fill="none" stroke="rgba(57,255,20,0.55)" stroke-width="0.7"/>
        <path d="M90,4 L96,4 L96,10" fill="none" stroke="rgba(57,255,20,0.55)" stroke-width="0.7"/>
        <path d="M4,90 L4,96 L10,96" fill="none" stroke="rgba(57,255,20,0.55)" stroke-width="0.7"/>
        <path d="M96,90 L96,96 L90,96" fill="none" stroke="rgba(57,255,20,0.55)" stroke-width="0.7"/>
      </g>
      <circle cx="50" cy="50" r="0.8" fill="#39ff14" opacity="0.9"/>
    </svg>
  </div>

  <!-- Range readout -->
  <div id="range-readout">
    <div id="rr-range">RNG: ‚Äîm</div>
    <div id="rr-elev"  style="color:var(--g2)">ELV: ‚Äî¬∞</div>
    <div id="rr-tof"   style="color:rgba(57,255,20,0.4)">TOF: ‚Äîs</div>
  </div>

  <!-- Left panel -->
  <div id="left-panel">
    <div class="lp-block">
      <span class="lp-label">SPEED</span>
      <span class="lp-val" id="lp-speed">0</span>
      <span class="lp-unit">km/h</span>
    </div>
    <div class="lp-block">
      <span class="lp-label">G-FORCE</span>
      <span class="lp-val" id="lp-g">0.00</span>
      <span class="lp-unit">g</span>
    </div>
    <div class="lp-block">
      <span class="lp-label">ROLL</span>
      <span class="lp-val" id="lp-roll">0¬∞</span>
      <span class="lp-unit">bank</span>
    </div>
    <!-- Elevation track -->
    <div id="elev-block">
      <span class="lp-label">ELEV</span>
      <div id="elev-track">
        <div id="elev-zero"></div>
        <div id="elev-ind"></div>
      </div>
      <div id="elev-val">+0.0¬∞</div>
    </div>
  </div>

  <!-- Right panel -->
  <div id="right-panel">
    <div class="rp-block">
      <span class="rp-label">HEADING</span>
      <span class="rp-val" id="rp-hdg">000¬∞</span>
      <span class="rp-unit">mag north</span>
    </div>
    <div class="rp-block">
      <span class="rp-label">PITCH</span>
      <span class="rp-val" id="rp-pitch">0.0¬∞</span>
      <span class="rp-unit">fore/aft</span>
    </div>
    <div class="rp-block">
      <span class="rp-label">ACCEL-X</span>
      <span class="rp-val" id="rp-ax">0.0</span>
      <span class="rp-unit">m/s¬≤</span>
    </div>
    <div class="rp-block">
      <span class="rp-label">ACCEL-Y</span>
      <span class="rp-val" id="rp-ay">0.0</span>
      <span class="rp-unit">m/s¬≤</span>
    </div>
    <div class="rp-block">
      <span class="rp-label">TEMP</span>
      <span class="rp-val" id="rp-temp">85¬∞C</span>
      <span class="rp-unit">engine</span>
    </div>
  </div>

  <!-- GPS -->
  <div id="gps-panel">
    <div class="gp-row"><span class="gp-k">LAT</span><span class="gp-v acq" id="gp-lat">ACQUIRING</span></div>
    <div class="gp-row"><span class="gp-k">LON</span><span class="gp-v acq" id="gp-lon">ACQUIRING</span></div>
    <div class="gp-row"><span class="gp-k">ALT</span><span class="gp-v" id="gp-alt">‚Äîm</span></div>
    <div class="gp-row"><span class="gp-k">ACC</span><span class="gp-v" id="gp-acc">‚Äîm</span></div>
    <div id="gps-bar-wrap"><div id="gps-bar-fill"></div></div>
  </div>

  <!-- Live sensor readout -->
  <div id="sensor-live">
    <div class="sl-row"><span class="sl-k">GYRO-Œ±</span><span class="sl-v live" id="sl-alpha">‚Äî¬∞</span></div>
    <div class="sl-row"><span class="sl-k">GYRO-Œ≤</span><span class="sl-v live" id="sl-beta">‚Äî¬∞</span></div>
    <div class="sl-row"><span class="sl-k">GYRO-Œ≥</span><span class="sl-v live" id="sl-gamma">‚Äî¬∞</span></div>
    <div class="sl-row"><span class="sl-k">|ACCEL|</span><span class="sl-v live" id="sl-mag">‚Äîg</span></div>
    <div class="sl-row"><span class="sl-k">BATT</span><span class="sl-v" id="sl-batt">‚Äî%</span></div>
    <div class="sl-row"><span class="sl-k">GPS-SPD</span><span class="sl-v" id="sl-spd">‚Äîkm/h</span></div>
  </div>

  <!-- Live graph -->
  <div id="graph-panel">
    <canvas id="graph-canvas" width="130" height="40"></canvas>
    <div class="graph-lbl">ACCEL HISTORY ¬∑ LIVE</div>
  </div>

  <!-- Minimap -->
  <div id="minimap-wrap">
    <canvas id="minimap-canvas" width="80" height="80"></canvas>
    <div id="minimap-lbl">TACTICAL MAP</div>
  </div>

  <!-- Fire zone -->
  <div id="fire-zone">
    <div id="ammo-sel">
      <button class="ammo-btn active" onclick="setAmmo('APFSDS',this)">APFSDS</button>
      <button class="ammo-btn" onclick="setAmmo('HEAT',this)">HEAT</button>
      <button class="ammo-btn" onclick="setAmmo('HE',this)">HE-FRAG</button>
      <button class="ammo-btn" onclick="setAmmo('SMKE',this)">SMOKE</button>
    </div>
    <div id="ammo-display">
      <div class="ammo-lbl">ROUNDS</div>
      <div id="ammo-count">42</div>
      <div class="ammo-type-lbl" id="ammo-type-disp">APFSDS</div>
    </div>
    <button id="fire-btn" ontouchstart="fireGun(event)" onclick="fireGun(event)">FIRE</button>
  </div>

  <div id="lock-msg">TILT DEVICE TO AIM ¬∑ FIRE TO SHOOT</div>

  <!-- Bottom bar -->
  <div id="bottom-hud">
    <span id="sb-mode">‚óâ COMBAT READY</span>
    <span class="sb-sep">‚îÇ</span>
    <span id="sb-ammo">APFSDS √ó42</span>
    <span class="sb-sep">‚îÇ</span>
    <span id="sb-sens">SENSORS: 0</span>
    <span class="sb-spacer"></span>
    <span id="sb-fuel">FUEL ‚Äî%</span>
    <span class="sb-sep">‚îÇ</span>
    <span id="sb-sys">SYS: NOMINAL</span>
    <span class="sb-sep">‚îÇ</span>
    <span id="sb-time">00:00:00</span>
  </div>
</div>

<script>
'use strict';
/* ‚ïê‚ïê STATE ‚ïê‚ïê */
const S = {
  alpha:0,beta:0,gamma:0,
  alphaS:0,betaS:0,gammaS:0,
  ax:0,ay:0,az:0,gForce:1,
  lat:null,lon:null,alt:null,gpsAcc:null,
  gpsSpeed:0,gpsOk:false,
  ammo:42,ammoType:'APFSDS',
  ammoTypes:{APFSDS:42,HEAT:16,'HE-FRAG':24,SMOKE:8},
  fuelPct:null,
  gyroOk:false,accelOk:false,compassOk:false,
  engineTemp:85,lockPct:0,hitCount:0,
  sensorCount:0,
  gpsTrail:[],
  camOk:false,
  accelHistory:[],
};

/* ‚ïê‚ïê COMPASS TAPE ‚ïê‚ïê */
const TAPE_W = 13;
function buildTape(){
  const inn=document.getElementById('compass-inner');
  inn.innerHTML='';
  for(let d=-720;d<=720;d+=5){
    const nd=((d%360)+360)%360;
    const dirs={0:'N',45:'NE',90:'E',135:'SE',180:'S',225:'SW',270:'W',315:'NW'};
    const sp=document.createElement('span');
    sp.style.cssText=`display:inline-flex;align-items:center;justify-content:center;width:${TAPE_W}px;flex-shrink:0;`;
    if(dirs[nd]){
      sp.className=['N','S','E','W'].includes(dirs[nd])?'c-major':'c-minor';
      sp.textContent=dirs[nd];
    } else if(nd%10===0){
      const t=document.createElement('span');
      t.style.cssText='display:inline-block;width:1px;height:8px;background:rgba(57,255,20,0.28);';
      sp.appendChild(t);
    } else {
      const t=document.createElement('span');
      t.style.cssText='display:inline-block;width:1px;height:5px;background:rgba(57,255,20,0.15);';
      sp.appendChild(t);
    }
    inn.appendChild(sp);
  }
}
buildTape();
const TAPE_ZERO = 720/5*TAPE_W;

function updateTape(h){
  const inn=document.getElementById('compass-inner');
  const tw=document.getElementById('compass-tape').offsetWidth||300;
  inn.style.transform=`translateX(${tw/2-TAPE_ZERO-h*TAPE_W/5}px)`;
}

/* ‚ïê‚ïê CAMERA ‚ïê‚ïê */
async function startCamera(){
  const vid=document.getElementById('camera-video');
  const dot=document.getElementById('cam-dot');
  const lbl=document.getElementById('cam-label');
  const offEl=document.querySelector('#camera-bg #cam-offline');
  try{
    // Try rear camera first
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},
      audio:false
    });
    vid.srcObject=stream;
    vid.style.display='block';
    offEl.style.display='none';
    dot.classList.add('live');
    lbl.textContent='CAM LIVE';
    S.camOk=true;
    return true;
  } catch(e){
    console.warn('Camera denied:',e);
    vid.style.display='none';
    offEl.style.display='flex';
    dot.classList.remove('live');
    lbl.textContent='CAM OFFLINE';
    return false;
  }
}

/* ‚ïê‚ïê ACTIVATE ‚ïê‚ïê */
async function activateSystems(){
  const log=document.getElementById('boot-log');
  const logLine=(txt,cls)=>{
    const sp=document.createElement('span');
    sp.className=cls||'';sp.textContent=txt;
    log.appendChild(document.createElement('br'));
    log.appendChild(sp);
  };
  log.textContent='';
  logLine('Initializing systems...','');

  // Camera
  logLine('Requesting camera...','');
  const camOk=await startCamera();
  logLine(camOk?'‚úì Camera: LIVE':'‚ö† Camera: DENIED (grant in browser settings).',camOk?'log-ok':'log-warn');

  // DeviceOrientation
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    try{
      const r=await DeviceOrientationEvent.requestPermission();
      if(r==='granted'){S.sensorCount++;logLine('‚úì Gyroscope + Compass: ONLINE','log-ok');}
      else logLine('‚ö† Orientation: DENIED','log-warn');
    }catch(e){logLine('‚ö† Orientation: '+e.message,'log-warn');}
  } else if(typeof DeviceOrientationEvent!=='undefined'){
    S.sensorCount++;logLine('‚úì Gyroscope + Compass: ONLINE','log-ok');
  }

  // DeviceMotion
  if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){
    try{
      const r=await DeviceMotionEvent.requestPermission();
      if(r==='granted'){S.sensorCount++;logLine('‚úì Accelerometer: ONLINE','log-ok');}
      else logLine('‚ö† Accelerometer: DENIED','log-warn');
    }catch(e){}
  } else if(typeof DeviceMotionEvent!=='undefined'){
    S.sensorCount++;logLine('‚úì Accelerometer: ONLINE','log-ok');
  }

  window.addEventListener('deviceorientation',handleOri,true);
  window.addEventListener('devicemotionabsolute',handleMotion,true);
  window.addEventListener('devicemotion',handleMotion,true);

  // GPS
  logLine('‚åõ GPS: Acquiring...','log-warn');
  startGPS();

  // Battery
  if(navigator.getBattery){
    navigator.getBattery().then(b=>{
      updateBatt(b);
      b.addEventListener('levelchange',()=>updateBatt(b));
      b.addEventListener('chargingchange',()=>updateBatt(b));
    });
    S.sensorCount++;logLine('‚úì Battery API: ONLINE','log-ok');
  } else {
    S.fuelPct=78;logLine('‚ö† Battery: Simulated','log-warn');
  }

  // Wake lock
  if('wakeLock' in navigator){
    try{await navigator.wakeLock.request('screen');logLine('‚úì Screen: ALWAYS ON','log-ok');}catch(e){}
  }

  document.getElementById('sb-sens').textContent='SENSORS: '+S.sensorCount;
  logLine('‚ñ∂ LAUNCHING HUD...','log-ok');

  setTimeout(()=>{
    document.getElementById('boot').classList.add('gone');
    document.getElementById('hud').classList.add('active');
    startHUD();
    startClock();
    startGraphLoop();
    document.getElementById('lock-msg').style.display='block';
  },1400);
}

/* ‚ïê‚ïê SENSORS ‚ïê‚ïê */
function handleOri(e){
  const k=0.14;
  let dA=(e.alpha||0)-S.alphaS;
  if(dA>180)dA-=360; if(dA<-180)dA+=360;
  S.alphaS+=k*dA;
  if(S.alphaS<0)S.alphaS+=360; if(S.alphaS>=360)S.alphaS-=360;
  S.betaS +=k*((e.beta||0)-S.betaS);
  S.gammaS+=k*((e.gamma||0)-S.gammaS);
  S.alpha=S.alphaS; S.beta=S.betaS; S.gamma=S.gammaS;
  S.gyroOk=true; S.compassOk=true;
}

let lastShake=0;
function handleMotion(e){
  const acc=e.accelerationIncludingGravity;
  if(!acc)return;
  S.ax=acc.x||0; S.ay=acc.y||0; S.az=acc.z||0;
  S.accelOk=true;
  const mag=Math.sqrt(S.ax**2+S.ay**2+S.az**2);
  S.gForce=mag/9.81;
  S.accelHistory.push(S.gForce);
  if(S.accelHistory.length>130)S.accelHistory.shift();
  const delta=Math.abs(mag-9.81);
  if(delta>16){const n=Date.now();if(n-lastShake>1000){lastShake=n;triggerImpact();}}
  if(!S.gpsOk){
    const lat=Math.sqrt(S.ax**2+S.ay**2);
    S.gpsSpeed=Math.max(0,Math.min(80,S.gpsSpeed+(lat-0.1)*0.5));
    if(lat<0.15)S.gpsSpeed=Math.max(0,S.gpsSpeed-0.4);
  }
}

/* ‚ïê‚ïê GPS ‚ïê‚ïê */
function startGPS(){
  if(!navigator.geolocation)return;
  navigator.geolocation.watchPosition(p=>{
    S.lat=p.coords.latitude; S.lon=p.coords.longitude;
    S.alt=p.coords.altitude; S.gpsAcc=p.coords.accuracy;
    S.gpsSpeed=(p.coords.speed||0)*3.6;
    S.gpsOk=true;
    S.gpsTrail.push({lat:S.lat,lon:S.lon});
    if(S.gpsTrail.length>200)S.gpsTrail.shift();
    renderGPS();
  },err=>{
    const m={1:'DENIED',2:'UNAVAIL',3:'TIMEOUT'};
    document.getElementById('gp-lat').textContent=m[err.code]||'ERR';
  },{enableHighAccuracy:true,maximumAge:0,timeout:20000});
}

function renderGPS(){
  const la=document.getElementById('gp-lat'),lo=document.getElementById('gp-lon');
  la.classList.remove('acq'); lo.classList.remove('acq');
  la.textContent=S.lat.toFixed(5)+(S.lat>=0?'¬∞N':'¬∞S');
  lo.textContent=S.lon.toFixed(5)+(S.lon>=0?'¬∞E':'¬∞W');
  document.getElementById('gp-alt').textContent=S.alt?Math.round(S.alt)+'m':'‚Äîm';
  document.getElementById('gp-acc').textContent=S.gpsAcc?'¬±'+Math.round(S.gpsAcc)+'m':'‚Äîm';
  const acc=Math.min(100,Math.max(0,100-S.gpsAcc/100*100));
  document.getElementById('gps-bar-fill').style.width=acc+'%';
  document.getElementById('sl-spd').textContent=Math.round(S.gpsSpeed)+'km/h';
}

/* ‚ïê‚ïê BATTERY ‚ïê‚ïê */
function updateBatt(b){
  S.fuelPct=Math.round(b.level*100);
  const charging=b.charging?' ‚ö°':'';
  document.getElementById('sl-batt').textContent=S.fuelPct+'%'+charging;
  document.getElementById('sb-fuel').textContent='FUEL '+S.fuelPct+'%'+(b.charging?' CHG':'');
}

/* ‚ïê‚ïê HUD LOOP ‚ïê‚ïê */
let simTime=0;
function startHUD(){
  let last=0;
  function frame(ts){
    const dt=(ts-last)/1000; last=ts;
    if(dt>0&&dt<1)tick(dt);
    renderHUD();
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function tick(dt){
  simTime+=dt;
  const thr=S.gpsSpeed/72;
  S.engineTemp+=((thr*120+80)-S.engineTemp)*dt*0.05;
  S.engineTemp=Math.max(70,Math.min(115,S.engineTemp));
  const mv=Math.abs(S.ax)+Math.abs(S.ay);
  S.lockPct=Math.min(100,Math.max(0,S.lockPct+(mv<1.5?25:-40)*dt));
  if(!S.accelOk&&!S.gpsOk){
    S.gpsSpeed=25+Math.sin(simTime*0.3)*18;
    S.gForce=1+Math.abs(Math.sin(simTime*0.5))*0.12;
    S.accelHistory.push(S.gForce);
    if(S.accelHistory.length>130)S.accelHistory.shift();
  }
  if(!S.gyroOk){
    S.alpha=(simTime*10)%360; S.alphaS=S.alpha;
    S.beta=Math.sin(simTime*0.4)*10; S.betaS=S.beta;
    S.gamma=Math.sin(simTime*0.3)*7; S.gammaS=S.gamma;
  }
  if(S.fuelPct===null){S.fuelPct=Math.max(0,78-simTime*0.01);}
  renderMinimap();
}

function renderHUD(){
  const h=S.alpha, p=S.beta, r=S.gamma;
  // Compass
  updateTape(h);
  const DIRS=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  document.getElementById('compass-hdg').textContent=
    'HDG '+Math.round(h).toString().padStart(3,'0')+'¬∞ '+DIRS[Math.round(h/22.5)%16];
  document.getElementById('rp-hdg').textContent=Math.round(h).toString().padStart(3,'0')+'¬∞';

  // Elevation
  const elev=-p, ec=Math.max(-10,Math.min(20,elev));
  const ep=(ec+10)/30;
  document.getElementById('elev-ind').style.top=((1-ep)*100)+'%';
  document.getElementById('elev-val').textContent=(elev>=0?'+':'')+elev.toFixed(1)+'¬∞';

  // Range calc
  const vel=1650, mass=4.8, Cd=0.05, A=Math.PI*0.06**2;
  const rng=ec>0?Math.round(vel**2*Math.sin(2*ec*Math.PI/180)/9.81):2000;
  const rd=Math.min(5000,Math.max(200,rng));
  const vR=vel*Math.exp(-0.5*Cd*1.225*A*rd/mass);
  const tof=rd/((vel+vR)/2);
  document.getElementById('rr-range').textContent='RNG: '+rd+'m';
  document.getElementById('rr-elev').textContent='ELV: '+elev.toFixed(1)+'¬∞';
  document.getElementById('rr-tof').textContent='TOF: '+tof.toFixed(2)+'s';

  // Reticle
  document.getElementById('reticle-group').style.transform=`rotate(${-r*0.5}deg)`;
  document.getElementById('horizon-line').style.transform=`translateY(-50%) rotate(${-r}deg)`;
  document.getElementById('lock-ring').className=S.lockPct>=90?'locked':'';

  // Right panel
  document.getElementById('rp-pitch').textContent=p.toFixed(1)+'¬∞';
  document.getElementById('rp-ax').textContent=S.ax.toFixed(1);
  document.getElementById('rp-ay').textContent=S.ay.toFixed(1);
  const temp=Math.round(S.engineTemp);
  const tEl=document.getElementById('rp-temp');
  tEl.textContent=temp+'¬∞C';
  tEl.className='rp-val'+(temp>105?' red':temp>93?' amber':'');

  // Left panel
  const spEl=document.getElementById('lp-speed');
  spEl.textContent=Math.round(S.gpsSpeed);
  spEl.className='lp-val'+(S.gpsSpeed>60?' amber':'');
  const gEl=document.getElementById('lp-g');
  gEl.textContent=S.gForce.toFixed(2);
  gEl.className='lp-val'+(S.gForce>2?' red':S.gForce>1.3?' amber':'');
  document.getElementById('lp-roll').textContent=r.toFixed(1)+'¬∞';

  // Live sensor panel
  document.getElementById('sl-alpha').textContent=h.toFixed(1)+'¬∞';
  document.getElementById('sl-beta').textContent=p.toFixed(1)+'¬∞';
  document.getElementById('sl-gamma').textContent=r.toFixed(1)+'¬∞';
  document.getElementById('sl-mag').textContent=S.gForce.toFixed(3)+'g';

  // Status bar
  document.getElementById('sb-ammo').textContent=S.ammoType+' √ó'+S.ammo;
  document.getElementById('sb-sys').textContent='SYS: '+(S.engineTemp>105?'OVERHEAT':S.engineTemp>93?'HOT':'NOMINAL');
  if(S.fuelPct!==null)document.getElementById('sb-fuel').textContent='FUEL '+S.fuelPct+'%';
}

/* ‚ïê‚ïê LIVE GRAPH ‚ïê‚ïê */
const gCtx=document.getElementById('graph-canvas').getContext('2d');
function startGraphLoop(){
  setInterval(drawGraph,60);
}
function drawGraph(){
  const w=130,h=40;
  gCtx.clearRect(0,0,w,h);
  gCtx.fillStyle='rgba(1,4,1,0.0)';gCtx.fillRect(0,0,w,h);
  // Grid line at 1g
  const hist=S.accelHistory;
  if(hist.length<2)return;
  const mn=0.5,mx=2.5;
  gCtx.strokeStyle='rgba(57,255,20,0.1)';gCtx.lineWidth=0.5;
  gCtx.beginPath();const y1g=h-(1-mn)/(mx-mn)*h;
  gCtx.moveTo(0,y1g);gCtx.lineTo(w,y1g);gCtx.stroke();
  // Line
  gCtx.beginPath();gCtx.strokeStyle='#39ff14';gCtx.lineWidth=1.2;
  gCtx.shadowBlur=5;gCtx.shadowColor='#39ff14';
  hist.forEach((v,i)=>{
    const x=w*(i/(hist.length-1));
    const yv=h-(Math.max(mn,Math.min(mx,v))-mn)/(mx-mn)*h;
    i===0?gCtx.moveTo(x,yv):gCtx.lineTo(x,yv);
  });
  gCtx.stroke();
  gCtx.shadowBlur=0;
}

/* ‚ïê‚ïê MINIMAP ‚ïê‚ïê */
let mmBase=null;
const mmCtx=document.getElementById('minimap-canvas').getContext('2d');
function renderMinimap(){
  const w=80,h=80;
  mmCtx.clearRect(0,0,w,h);
  mmCtx.fillStyle='rgba(1,4,1,0.88)';mmCtx.fillRect(0,0,w,h);
  mmCtx.strokeStyle='rgba(57,255,20,0.08)';mmCtx.lineWidth=0.4;
  for(let i=0;i<=w;i+=16){
    mmCtx.beginPath();mmCtx.moveTo(i,0);mmCtx.lineTo(i,h);mmCtx.stroke();
    mmCtx.beginPath();mmCtx.moveTo(0,i);mmCtx.lineTo(w,i);mmCtx.stroke();
  }
  if(!S.lat||!S.lon){
    mmCtx.fillStyle='rgba(57,255,20,0.2)';mmCtx.font='6px Share Tech Mono';
    mmCtx.textAlign='center';mmCtx.fillText('NO GPS',w/2,h/2);return;
  }
  if(!mmBase)mmBase={lat:S.lat,lon:S.lon};
  const cx=40-100000*(S.lon-mmBase.lon);
  const cy=40+100000*(S.lat-mmBase.lat);
  if(S.gpsTrail.length>1){
    mmCtx.beginPath();mmCtx.strokeStyle='rgba(57,255,20,0.3)';mmCtx.lineWidth=1;
    S.gpsTrail.forEach((pt,i)=>{
      const px=40-100000*(pt.lon-mmBase.lon);
      const py=40+100000*(pt.lat-mmBase.lat);
      i===0?mmCtx.moveTo(px,py):mmCtx.lineTo(px,py);
    });mmCtx.stroke();
  }
  mmCtx.save();mmCtx.translate(cx,cy);mmCtx.rotate(S.alpha*Math.PI/180);
  mmCtx.fillStyle='#39ff14';mmCtx.shadowBlur=5;mmCtx.shadowColor='#39ff14';
  mmCtx.fillRect(-2.5,-3.5,5,7);
  mmCtx.fillRect(-0.7,-7,1.4,5);
  mmCtx.restore();
  mmCtx.beginPath();mmCtx.arc(cx,cy,12,0,Math.PI*2);
  mmCtx.strokeStyle='rgba(57,255,20,0.12)';mmCtx.lineWidth=0.5;mmCtx.stroke();
}

/* ‚ïê‚ïê FIRE ‚ïê‚ïê */
const RELOAD_T={APFSDS:5000,HEAT:6000,'HE-FRAG':4000,SMOKE:3000};
let reloading=false;
function fireGun(e){
  if(e)e.preventDefault();
  if(reloading)return;
  if(S.ammo<=0){triggerAlert('AMMO DEPLETED');return;}
  S.ammo--;reloading=true;
  const ff=document.getElementById('fire-flash');
  ff.classList.add('fired');
  document.getElementById('fire-btn').classList.add('firing');
  if(navigator.vibrate)navigator.vibrate([55,25,35,15,75]);
  setTimeout(()=>ff.classList.remove('fired'),110);
  setTimeout(()=>document.getElementById('fire-btn').classList.remove('firing'),190);
  document.getElementById('ammo-count').textContent=S.ammo;
  const rt=RELOAD_T[S.ammoType]||5000;
  let remaining=rt;
  const iv=setInterval(()=>{
    remaining-=80;
    const pct=Math.round((1-remaining/rt)*100);
    const btn=document.getElementById('fire-btn');
    if(btn)btn.textContent=pct+'%';
    if(remaining<=0){clearInterval(iv);reloading=false;if(btn)btn.textContent='FIRE';}
  },80);
  addMode('FIRED '+S.ammoType+' | '+S.ammo+' remaining');
}

/* ‚ïê‚ïê IMPACT ‚ïê‚ïê */
function triggerImpact(){
  S.hitCount++;
  document.getElementById('impact-flash').classList.add('hit');
  document.getElementById('threat-overlay').classList.add('active');
  document.getElementById('hud').classList.add('shaking');
  if(navigator.vibrate)navigator.vibrate([180,45,130,45,260]);
  spawnParticles();
  setTimeout(()=>{
    document.getElementById('impact-flash').classList.remove('hit');
    document.getElementById('threat-overlay').classList.remove('active');
    document.getElementById('hud').classList.remove('shaking');
  },550);
  addMode('‚ö† IMPACT ‚Äî HIT #'+S.hitCount);
}
function triggerAlert(msg){
  document.getElementById('threat-text').textContent='‚ö† '+msg+' ‚ö†';
  document.getElementById('threat-overlay').classList.add('active');
  if(navigator.vibrate)navigator.vibrate([90,40,90]);
  setTimeout(()=>document.getElementById('threat-overlay').classList.remove('active'),2000);
}

/* ‚ïê‚ïê PARTICLES ‚ïê‚ïê */
const shC=document.getElementById('shake-canvas');
const shCtx=shC.getContext('2d');
let parts=[];
function resizeSh(){shC.width=window.innerWidth;shC.height=window.innerHeight;}
window.addEventListener('resize',resizeSh);resizeSh();
function spawnParticles(){
  const cx=window.innerWidth/2,cy=window.innerHeight/2;
  for(let i=0;i<50;i++){
    const a=Math.random()*Math.PI*2,sp=Math.random()*8+2;
    parts.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      life:1,decay:Math.random()*0.03+0.018,
      size:Math.random()*3+0.8,color:Math.random()>0.5?'#ff2020':'#ffb000'});
  }
}
function animParts(){
  shCtx.clearRect(0,0,shC.width,shC.height);
  parts=parts.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.18;p.life-=p.decay;
    shCtx.globalAlpha=p.life;shCtx.fillStyle=p.color;
    shCtx.shadowBlur=5;shCtx.shadowColor=p.color;
    shCtx.beginPath();shCtx.arc(p.x,p.y,p.size,0,Math.PI*2);shCtx.fill();
    return p.life>0;
  });
  shCtx.globalAlpha=1;shCtx.shadowBlur=0;
  requestAnimationFrame(animParts);
}
animParts();

/* ‚ïê‚ïê AMMO ‚ïê‚ïê */
function setAmmo(type,btn){
  S.ammoType=type==='SMKE'?'SMOKE':type;
  S.ammo=S.ammoTypes[S.ammoType]||20;
  document.getElementById('ammo-count').textContent=S.ammo;
  document.getElementById('ammo-type-disp').textContent=S.ammoType;
  document.querySelectorAll('.ammo-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
}

/* ‚ïê‚ïê CLOCK ‚ïê‚ïê */
function startClock(){
  setInterval(()=>{
    const n=new Date();
    document.getElementById('sb-time').textContent=
      [n.getHours(),n.getMinutes(),n.getSeconds()].map(x=>String(x).padStart(2,'0')).join(':');
  },1000);
}

/* ‚ïê‚ïê MODE TEXT ‚ïê‚ïê */
const mQ=[];let mShowing=false;
function addMode(msg){mQ.push(msg);if(!mShowing)nextMode();}
function nextMode(){
  if(!mQ.length){mShowing=false;return;}
  mShowing=true;
  document.getElementById('sb-mode').textContent='‚óâ '+mQ.shift();
  setTimeout(()=>{document.getElementById('sb-mode').textContent='‚óâ COMBAT READY';setTimeout(nextMode,200);},2200);
}

/* ‚ïê‚ïê KEYBOARD ‚ïê‚ïê */
document.addEventListener('keydown',e=>{
  if(!document.getElementById('hud').classList.contains('active'))return;
  if(e.code==='Space'){e.preventDefault();fireGun(null);}
  if(e.code==='KeyI')triggerImpact();
  if(e.code==='KeyA')triggerAlert('INCOMING MISSILE');
});

/* ‚ïê‚ïê TOUCH LOCK ‚ïê‚ïê */
document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
</script>
</body>
</html>
